---
title: "DCS210 Final Project"
subtitle: "Exploring COVID-19 Data"
author: "omarxinyijohn <br> John Mieszczanski & Omar Sarr & Xinyi Zhang"
institute: "Bates College"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      color: #000000
---
```{r load-packages, include = FALSE}
library(tidyverse)
library(tidymodels)
library(palmerpenguins)
library(knitr)
library(xaringanthemer)
library(broom)
library(lubridate)
library(devtools)
library(dsbox)
library(ggridges)
library(openintro)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(reactable)
library(gghighlight)
library(interactions)
```

```{r setup, include = FALSE}
# For better figure resolution
#knitr::opts_chunk$set(fig.retina = 3, dpi = 300, fig.width = 6, fig.asp = 0.618, out.width = "80%")
```

```{r load-data, include = FALSE}
US_deaths_cases <- 
  read_csv("/cloud/project/data/United_States_COVID-19_Cases_and_Deaths_by_State_over_Time.csv")

US_vaccinations <- 
  read_csv("/cloud/project/data/COVID-19_Vaccinations_in_the_United_States_Jurisdiction.csv")
```

```{r background-text-color, echo = FALSE}
style_xaringan(
  title_slide_background_color = "#000000",
  title_slide_text_color = "#FFFFFF"
)
```

### Introduction

Reported first in December, 2019, the COVID-19 pandemic constitutes the largest global public health crisis in a century, with daunting health and socioeconomic challenges. In the United States alone, more than 700,000 people have lost their lives due to the public health crisis. The progress in vaccination rates, as well as the spread of Delta variant, added more nuances to the overall situation.

### Overall Goal

In this project, we focus on the COVID-19 data in the U.S. We aim to explore:

- The fluctuations of deaths and cases across time since January, 2020

- Trying to predict the number of daily new deaths from daily new cases
    
- The potential correlation/relationship between seasons and deaths and cases

- The potential correlation/relationship between vaccination rates and deaths and cases across time

---

### COVID-19 Cases and Deaths - The Beginning
On January 22nd, 2020, the CDC began tracking daily COVID19 cases and deaths
across the United States and its territories. Eventually, on March 11th, 2020,
WHO declared COVID-19 a global pandemic. This day also coincided with the NBA
shutting down indefinitely. Two days later, Bates College announced they would 
be sending us home!

How do these two key dates compare the worst day(s) of the pandemic?
```{r key-dates-table, echo = FALSE}
new_US_deaths_cases <- US_deaths_cases %>%
  filter(!(state %in% c("NYC", "PR", "GU",
                           "VI", "MP", "RMI",
                           "AS", "PW", "FSM"))) %>%
  group_by(submission_date) %>%
  summarise(total_new_cases = sum(new_case),
            total_new_deaths = sum(new_death),
            total_cases = sum(tot_cases),
            total_deaths = sum(tot_death)) 

new_US_deaths_cases$submission_date = as.Date(new_US_deaths_cases$submission_date,
                                              format="%m/%d/%Y")

new_US_deaths_cases <- new_US_deaths_cases %>%
  arrange(desc(submission_date))

new_US_deaths_cases %>%
  filter(submission_date %in% c(as.Date("2020-01-22"), 
                                as.Date("2020-03-11"), 
                                as.Date("2020-03-13"), 
                                as.Date("2021-01-06"),
                                as.Date("2021-01-13"))) %>%
  reactable()
```

```{r find-max-cases-date, echo = FALSE, include = FALSE}
# How we obtained the date with the highest number of new cases
new_US_deaths_cases %>% 
  slice_max(total_new_cases, n = 5) 

max_cases_row <- new_US_deaths_cases %>% 
  slice_max(total_new_cases, n = 1) 

max_cases_date <- max_cases_row$submission_date

max_cases_date
```

```{r find-max-deaths-date, echo = FALSE, include = FALSE}
# How we obtained the date with the highest number of new deaths
new_US_deaths_cases %>%
  slice_max(total_new_deaths, n = 5)

max_deaths_row <- new_US_deaths_cases %>% 
  slice_max(total_new_deaths, n = 1) 

max_deaths_date <- max_deaths_row$submission_date

max_deaths_date
```
---
<html>
<head>
<style>
p {margin-top: 0.5em ;
   margin-bottom: 1em ;}
h3 {margin-top: 0.5em ;
   margin-bottom: 0.5em ;}
</style>
</head>
<body>
<h3>COVID-19 Cases and Deaths - How did they evolve with time?</h3>
<p>Throughout this pandemic, we have experienced periods of low cases and deaths and periods of high cases and deaths. These ebbs and flows are typically called "waves". Our first goal was to visualize the "waves" of the pandemic - when were things the worst and when did things seem to be better?</p>
</body>
</html>

```{r cases-vs-time, echo = FALSE, fig.width=14, fig.height=6, fig.alt = "Scatterplot of daily new cases versus time where we show the various ebbs and flows of COVID cases."}
new_US_deaths_cases %>%
  ggplot() +
  geom_point(aes(x = submission_date, y = total_new_cases)) +
  labs(title = "Daily New Cases vs. Time",
       x = "Date",
       y = "Daily New Cases") +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
        axis.text.x = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),
        axis.text.y = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),  
        axis.title.x = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = 0, 
                                    face = "plain"),
        axis.title.y = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 90, 
                                    hjust = .5, 
                                    vjust = 1, 
                                    face = "plain"),
        plot.title = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = .5, 
                                    face = "plain")) +
  scale_x_date(date_breaks = "2 month", date_labels =  "%b %Y") +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
```
---
<html>
<head>
<style>
p {margin-top: 0.5em ;
   margin-bottom: 1em ;}
h3 {margin-top: 0.5em ;
   margin-bottom: 0.5em ;}
</style>
</head>
<body>
<h3>COVID-19 Cases and Deaths - How did they evolve with time?</h3>
</body>
</html>
```{r deaths-vs-time, echo = FALSE, fig.width=16, fig.height=8, fig.alt = "Scatterplot of daily new deaths versus time where we show the various ebbs and flows of COVID deaths."}
new_US_deaths_cases %>%
  ggplot() +
  geom_point(aes(x = submission_date, y = total_new_deaths)) +
  labs(title = "Daily New Deaths vs. Time",
       x = "Date",
       y = "Daily New Deaths") +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
        axis.text.x = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),
        axis.text.y = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),  
        axis.title.x = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = 0, 
                                    face = "plain"),
        axis.title.y = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 90, 
                                    hjust = .5, 
                                    vjust = 1, 
                                    face = "plain"),
        plot.title = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = .5, 
                                    face = "plain")) +
  scale_x_date(date_breaks = "2 month", date_labels =  "%b %Y") +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
```
---
### COVID-19 Cases and Deaths - What is the correlation?
Before we use the R `ccf()` function, let's take a look at the relationship between
cases and deaths with no lag:

```{r deaths-vs-cases, echo = FALSE, fig.width = 14, fig.height = 6, fig.alt = "Scatterplot of daily new deaths versus daily cases where we show that there appears to be a linear relationship between the two variables."}
new_US_deaths_cases %>%
  ggplot(aes(x = total_new_cases, y = total_new_deaths)) +
  geom_point() +
  labs(title = "Daily New Deaths vs. Daily New Cases",
       x = "Daily New Cases",
       y = "Daily New Deaths") +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
        axis.text.x = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),
        axis.text.y = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),  
        axis.title.x = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = 0, 
                                    face = "plain"),
        axis.title.y = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 90, 
                                    hjust = .5, 
                                    vjust = 1, 
                                    face = "plain"),
        plot.title = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = .5, 
                                    face = "plain")) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
```
---
### COVID-19 Cases and Deaths - What is the correlation?
Before we use the R `ccf()` function, let's take a look at the relationship between
cases and deaths with no lag:

```{r deaths-cases-fit, echo = FALSE}
deaths_cases_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(total_new_deaths ~ total_new_cases, data = new_US_deaths_cases) 
```

```{r deaths-vs-cases-line-plot, echo = FALSE, message = FALSE, fig.width = 14, fig.height = 6, fig.alt = "Scatterplot of daily new deaths versus daily cases that includes the line of best fit where we again show that there appears to be a linear relationship between the two variables, this time including the linear regression."}
new_US_deaths_cases %>%
  ggplot(aes(x = total_new_cases, y = total_new_deaths)) +
  geom_point() +
  geom_line(aes(x = total_new_cases, y = augment(deaths_cases_fit$fit)$.fitted), 
            size = 0.75, 
            color = "blue") +
  labs(title = "Daily New Deaths vs. Daily New Cases",
       x = "Daily New Cases",
       y = "Daily New Deaths") +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
        axis.text.x = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),
        axis.text.y = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),  
        axis.title.x = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = 0, 
                                    face = "plain"),
        axis.title.y = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 90, 
                                    hjust = .5, 
                                    vjust = 1, 
                                    face = "plain"),
        plot.title = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = .5, 
                                    face = "plain")) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
```
---
### COVID-19 Cases and Deaths - What is the correlation?
Let's take a look at the residuals plot to assess whether a linear model is appropriate:

```{r deaths-cases-residual-plot, echo = FALSE, message = FALSE, fig.width = 14, fig.height = 6, fig.alt = "Residuals scatterplot of residuals versus predicted daily new deaths where we show that the residuals for the most most are evenly spread out from zero, and thus a linear model is a good fit."}
new_US_deaths_cases %>%
  ggplot(aes(x = augment(deaths_cases_fit$fit)$.fitted, y = augment(deaths_cases_fit$fit)$.resid)) +
  geom_point() +
  geom_hline(yintercept = 0, color = "gray", lty = "dashed") +
  labs(title = "Predicted Daily New Deaths Residual Plot",
       x = "Predicted Daily New Deaths",
       y = "Residuals") +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
        axis.text.x = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),
        axis.text.y = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),  
        axis.title.x = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = 0, 
                                    face = "plain"),
        axis.title.y = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 90, 
                                    hjust = .5, 
                                    vjust = 1, 
                                    face = "plain"),
        plot.title = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = .5, 
                                    face = "plain")) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
```
---
### COVID-19 Cases and Deaths - What is the correlation?
Results from the linear regression:
```{r deaths-cases-linear-model, echo = FALSE}
deaths_cases_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(total_new_deaths ~ total_new_cases, data = new_US_deaths_cases) 

deaths_cases_fit

glance(deaths_cases_fit)
```

The linear model is given by `y = 0.01146x + 274.67437`. This tells us that for 
each additional daily case, we expect the number of daily deaths to increase on 
average by `0.01146`. Additionally, we can see $R^2 = 0.673$, which indicates 
that about 67.3% of the variation in the daily new deaths is dependent on 
daily new cases.
---
### COVID-19 Cases and Deaths - What is the correlation?
Typically, when we are comparing two variables $X$ and $Y$, we calculate the 
correlation coefficient 
$$\rho = \frac{\sigma_{XY}}{\sigma_X\sigma_Y}$$ 
The correlation coefficient describes how one variable moves in relation to 
another. When dealing with time series data and both $X$ and $Y$ 
are functions of time, the time series $Y_t$ might be related to past lags of 
the time series $X_t$. In other words, if our time series is discrete 
(it must be), we want to determine the relationship between $X_{t + h}$ and
$Y_t$ for $h = 0, \pm 1, \pm 2, ...$. The **cross correlation coefficient** is 
thus given by
$$\rho = \frac{\sigma_{X_{t + h}Y_t}}{\sigma_{X_{t + h}}\sigma_{Y_t}}$$ 
Two things to note :

- When one or more $X_{t + h}$, with $h$ *negative*, are predictors of $Y_t$, 
it is sometimes said that **x leads y**

- When one or more $X_{t + h}$, with $h$ *positive*, are predictors of $Y_t$, 
it is sometimes said that **x lags y** $^*$

.footnote[
$^*$ https://online.stat.psu.edu/stat510/lesson/8/8.2
]
---
### COVID-19 Cases and Deaths - What is the correlation?
```{r deaths-cases-cross-correlation, echo = FALSE, fig.width = 16, fig.height = 7.5, fig.alt = "Cross correlation plot of daily new cases and daily new deaths where we show that deaths appear to lag cases by approximately 7 days."}
xcf_plot <- function(df, x, y, title = "Cross Correlation", lag_var = 100){
  df_x <- eval(substitute(x), df)
  df_y <- eval(substitute(y), df)
  ccf.object <- ccf(df_x, df_y, plot = FALSE, lag.max = lag_var)
  output_table <- cbind(lag = ccf.object$lag, 
                        x.corr = ccf.object$acf) %>%
                          as_tibble() %>%
                          mutate(cat = ifelse(x.corr > 0, "green", "red"))
  output_table %>%
    ggplot(aes(x = lag, y = x.corr)) +
    geom_bar(stat = "identity", aes(fill = cat)) +
    scale_fill_manual(values = c("#339933", "#cc0000")) +
    ylab("Cross Correlation") +
    xlab("Lag (days)") +
    scale_y_continuous(limits = c(-1, 1)) +
    theme_bw() + 
    theme(legend.position = "none",
          axis.line = element_line(colour = "black"),
          axis.text.x = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),
          axis.text.y = element_text(color = "grey20", 
                                     size = 15, 
                                     angle = 0, 
                                     hjust = .5, 
                                     vjust = .5, 
                                     face = "plain"),  
          axis.title.x = element_text(color = "grey20", 
                                      size = 30, 
                                      angle = 0, 
                                      hjust = .5, 
                                      vjust = 0, 
                                      face = "plain"),
          axis.title.y = element_text(color = "grey20", 
                                      size = 30, 
                                      angle = 90, 
                                      hjust = .5, 
                                      vjust = 1, 
                                      face = "plain"),
          plot.title = element_text(color = "grey20", 
                                      size = 30, 
                                      angle = 0, 
                                      hjust = .5, 
                                      vjust = .5, 
                                      face = "plain")) +
    ggtitle(title) -> p
}     

# run the function
plot1 <- xcf_plot(df = new_US_deaths_cases, 
         x = new_US_deaths_cases$total_new_cases, 
         y = new_US_deaths_cases$total_new_deaths, 
         title = "Cross Correlation : Daily New Cases (X) and Daily New Deaths (Y)")

plot1
```
---
### COVID-19 Cases and Deaths - What is the correlation?
```{r deaths-cases-cross-correlation-zoom, echo = FALSE, fig.width = 16, fig.height = 7.5, fig.alt = "Zoomed in cross correlation plot of daily new cases and daily new deaths where we show that deaths appear to lag cases by approximately 7 days."}
plot2 <- xcf_plot(df = new_US_deaths_cases, 
         x = new_US_deaths_cases$total_new_cases, 
         y = new_US_deaths_cases$total_new_deaths, 
         title = "Cross Correlation : Daily New Cases (X) and Daily New Deaths (Y)",
         lag_var = 10)

plot2
```
---
### COVID-19 Cases and Deaths - What is the correlation?
```{r deaths-cases-cross-correlation-table, echo = FALSE, fig.show='hide'}
ccf_raw_data <- ccf(new_US_deaths_cases$total_new_cases, new_US_deaths_cases$total_new_deaths, plot = FALSE, lag.max = 14) 

ccf_raw_data <- data.frame(lag = ccf_raw_data$lag, CCF = ccf_raw_data$acf)
  
reactable(ccf_raw_data)
  
#data.frame(lag = correlation$ccf$lag, CCF = correlation$ccf$acf)
```
---
### COVID-19 Vaccinations Over Time
Now let's take a look at how the number people of vaccinated in the United States 
has evolved with time:
```{r edit-vaccine-data-frame, echo = FALSE}
new_US_vaccinations <- US_vaccinations %>%
  select(Date, Location, Series_Complete_Yes, 
         Series_Complete_Pop_Pct,
         Series_Complete_12PlusPop_Pct,
         Series_Complete_18PlusPop_Pct,
         Series_Complete_65PlusPop_Pct,
         Series_Complete_Janssen, Series_Complete_Moderna, 
         Series_Complete_Pfizer, Series_Complete_Unk_Manuf) %>%
  filter(Location %in% c("US"))

new_US_vaccinations$Date = as.Date(new_US_vaccinations$Date,
                                              format="%m/%d/%Y")
```

```{r vaccinated-vs-time-plot, echo = FALSE, fig.width = 14, fig.height = 7, fig.alt = "Scatterplot of percent of US Population fully vaccinated versus time which shows the stages of increase since the vaccination campaign began in the United States."}
new_US_vaccinations %>%
  filter(Series_Complete_Pop_Pct > 0) %>%
  ggplot() +
  geom_point(aes(x = Date, y = Series_Complete_Pop_Pct)) +
  labs(title = "Percent of US Population Fully Vaccinated vs. Time",
       x = "Date",
       y = "Percent of US Population") +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
        axis.text.x = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),
        axis.text.y = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),  
        axis.title.x = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = 0, 
                                    face = "plain"),
        axis.title.y = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 90, 
                                    hjust = .5, 
                                    vjust = 1, 
                                    face = "plain"),
        plot.title = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = .5, 
                                    face = "plain")) +
  scale_x_date(date_breaks = "1 month", date_labels =  "%b %Y") +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
```
---
### COVID-19 Vaccinations Over Time
Although the total population of the US is only about ~55% vaccinated as of early 
October, 2021, this does not paint a full picture. Let's break down this percentage
by age group:

```{r vaccinated-vs-time-facet, echo = FALSE, fig.width = 14, fig.height = 7, fig.alt = "Scatterplots of percent of US Population fully vaccinated versus time faced by age group which shows the differences in percentage vaccinated by age group (i.e. older populations have higher percentages)."}
Pop_Pct.labs <- c("% Fully Vaccinated 12+", 
                  "% Fully Vaccinated (Total Pop)",
                  "% Fully Vaccinated 18+", 
                  "% Fully Vaccinated 65+")
names(Pop_Pct.labs) <- c("Series_Complete_12PlusPop_Pct", 
                         "Series_Complete_Pop_Pct",
                         "Series_Complete_18PlusPop_Pct",
                         "Series_Complete_65PlusPop_Pct")

new_US_vaccinations %>%
  filter(Series_Complete_Yes > 0) %>%
  pivot_longer(cols = c(Series_Complete_Pop_Pct,
                        Series_Complete_12PlusPop_Pct,
                        Series_Complete_18PlusPop_Pct,
                        Series_Complete_65PlusPop_Pct),
               names_to = "Pop_Pct_Type",
               values_to = "Pop_Pct") %>%
  ggplot() +
  geom_point(aes(x = Date, y = Pop_Pct)) +
  facet_wrap(~Pop_Pct_Type,
             labeller = labeller(Pop_Pct_Type = Pop_Pct.labs)) + 
  labs(title = "Percent of US Population Fully Vaccinated vs. Time",
       subtitle = "Broken Down by Age Group",
       x = "Date",
       y = "Percent of US Population") +
  theme_bw() +
  theme(strip.text = element_text(size = 20),
        axis.line = element_line(colour = "black"),
        axis.text.x = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),
        axis.text.y = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),  
        axis.title.x = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = 0, 
                                    face = "plain"),
        axis.title.y = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 90, 
                                    hjust = .5, 
                                    vjust = 1, 
                                    face = "plain"),
        plot.title = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = .5, 
                                    face = "plain"),
        plot.subtitle = element_text(color = "grey20", 
                                    size = 20, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = .5, 
                                    face = "plain")) +
  scale_x_date(date_breaks = "2 month", date_labels =  "%b %Y") +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 5))
```
---
### Exploring the Relationship Between Vaccinations and Cases/Deaths
Next, let's take a look at how vaccinations and deaths have evolved over time
in conjunction with one another:

```{r join-cases-vaccine-data, echo = FALSE}
merged_US_data <- inner_join(new_US_vaccinations, new_US_deaths_cases, by = c("Date" = "submission_date")) %>%
  filter(Series_Complete_Yes > 0)
```

```{r dual-vaccine-deaths-plot, echo = FALSE, fig.width = 14, fig.height = 7, fig.alt = "Dual scatterplot of total number of US Population fully vaccinated versus time and total number of COVID deaths versus time which shows the stages of both deaths and vaccinations in conjunction."}
coeff <- 1

merged_US_data %>%
  ggplot(aes(x = Date)) +
  geom_point(aes(y = total_deaths / 10^3), color = "red") + 
  geom_point(aes(y = Series_Complete_Yes / 10^6), color = "blue") +
  scale_color_manual(name = "Data", values = c("total_deaths" = "red", "Series_Complete_Yes" = "blue")) +
  scale_y_continuous(
    name = "Total # of COVID Deaths (Thousands)",
    sec.axis = sec_axis(~.*coeff, 
                        name = "Total # of People Fully Vaccinated (Millions)",
                        scales::pretty_breaks(n = 10)),
    breaks = scales::pretty_breaks(n = 10)
  ) +
  labs(title = "Total Fully Vaccinated and Total Deaths vs. Time",
       x = "Date",
       color = "Color") +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
        axis.text.x = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),
        axis.text.y = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),
        axis.title.x = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = 0, 
                                    face = "plain"),
        axis.title.y.left = element_text(color = "red", 
                                    size = 25, 
                                    angle = 90, 
                                    hjust = .5, 
                                    vjust = 1, 
                                    face = "plain"),
        axis.title.y.right = element_text(color = "blue", 
                                    size = 25, 
                                    angle = 270, 
                                    hjust = .5, 
                                    vjust = 1, 
                                    face = "plain"),
        plot.title = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = .5, 
                                    face = "plain")) +
  scale_x_date(date_breaks = "1 month", date_labels =  "%b %Y")
```
---
### Exploring the Relationship Between Vaccinations and Cases/Deaths
```{r vaccines-deaths-cross-correlation1, echo = FALSE, include = FALSE, fig.width = 16, fig.height = 7.5, fig.alt = "Cross correlation plots of population percentage fully vaccinated and daily new deaths which seems to show that a decrease in deaths lags about 65 days behind an increase in vaccinations."}
vax_deaths_ccf_plot <- xcf_plot(df = merged_US_data, 
         x = merged_US_data$Series_Complete_Pop_Pct, 
         y = merged_US_data$total_new_deaths, 
         title = "Cross Correlation : Daily New Deaths (X) and Total Population Fully Vaccinated (Y)",
         lag_var = 250)

vax_deaths_ccf_plot
```

```{r vaccines-deaths-cross-correlation2, echo = FALSE, fig.width = 16, fig.height = 7.5, fig.alt = "Cross correlation plots of total population fully vaccinated and daily new deaths which seems to show that a decrease in deaths lags about 65 days behind an increase in vaccinations."}
vax_deaths_ccf_plot <- xcf_plot(df = merged_US_data, 
         x = merged_US_data$Series_Complete_Yes, 
         y = merged_US_data$total_new_deaths, 
         title = "Cross Correlation : Total Population Fully Vaccinated (X) and Daily New Deaths (Y)",
         lag_var = 250)

vax_deaths_ccf_plot
```
---
### Exploring the Relationship Between Vaccinations and Cases/Deaths
```{r vaccines-deaths-cross-correlation-zoom, echo = FALSE, fig.width = 16, fig.height = 7.5, fig.alt = "Zoomed in cross correlation plots of total population fully vaccinated and daily new deaths which seems to show that a decrease in deaths lags about 65 days behind an increase in vaccinations."}
vax_deaths_ccf_plot <- xcf_plot(df = merged_US_data, 
         x = merged_US_data$Series_Complete_Yes, 
         y = merged_US_data$total_new_deaths, 
         title = "Cross Correlation : Total Population Fully Vaccinated (X) and Daily New Deaths (Y)",
         lag_var = 100)

vax_deaths_ccf_plot
```
---
### Exploring the Relationship Between Vaccinations and Cases/Deaths
```{r vaccines-deaths-cross-correlation-table, echo = FALSE, fig.show='hide'}
ccf_raw_data2 <- ccf(merged_US_data$Series_Complete_Yes, merged_US_data$total_new_deaths, plot = FALSE, lag.max = 100) 

ccf_raw_data2 <- data.frame(lag = ccf_raw_data2$lag, CCF = ccf_raw_data2$acf)
  
reactable(ccf_raw_data2)
  
#data.frame(lag = correlation$ccf$lag, CCF = correlation$ccf$acf)
```
---
### Exploring the Seasonality of COVID-19
Let's explore the relationship between COVID-19 and the four seasons:
```{r edit-cases-data-by-season, echo = FALSE}
seasons_deaths_cases <- new_US_deaths_cases %>%
  mutate(season = case_when(
  month(submission_date) %in% c(9, 10, 11) ~ "Fall",
  month(submission_date) %in% c(12, 1, 2) ~ "Winter",
  month(submission_date) %in% c(3, 4, 5) ~ "Spring",
  month(submission_date) %in% c(6, 7, 8) ~ "Summer"
))
```

```{r add-season-cases-statistics, echo = FALSE}
avg_season <- seasons_deaths_cases %>%
  group_by(season) %>%
  summarise(median_ncases = median(total_new_cases, na.rm = TRUE),
            median_ndeaths = median(total_new_deaths, na.rm = TRUE),
            mean_ncases = mean(total_new_cases, na.rm = TRUE),
            mean_ndeaths = mean(total_new_deaths, na.rm = TRUE),
            sd_ncases = sd(total_new_cases, na.rm = TRUE),
            sd_ndeaths = sd(total_new_deaths, na.rm = TRUE),
            min_ncases = min(total_new_cases, na.rm = TRUE),
            max_ncases = max(total_new_cases, na.rm = TRUE),
            iqr_ncases = IQR(total_new_cases, na.rm = TRUE))
  
reactable(avg_season)
```

---
### Exploring the Seasonality of COVID-19
```{r seasons-ridge-plot, echo = FALSE, message = FALSE, fig.width = 16, fig.height = 7.5, fig.alt = "Ridges plot of cases grouped by season which shows which seasons tended to have higher case numbers."}
seasons_deaths_cases %>%
  ggplot(aes(x = total_new_cases / 10^3, 
             y = reorder(season, total_new_cases), 
             fill = season)) +
  geom_density_ridges(alpha = 0.2) +
  labs(title = "Ridge Plot of Daily New Cases by Season",
       x = "Daily New Cases (Thousands)",
       y = "Season",
       fill = "Season") +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
        axis.text.x = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),
        axis.text.y = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),  
        axis.title.x = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = 0, 
                                    face = "plain"),
        axis.title.y = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 90, 
                                    hjust = .5, 
                                    vjust = 1, 
                                    face = "plain"),
        plot.title = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = .5, 
                                    face = "plain"),
        legend.text = element_text(color = "grey20", 
                                    size = 15),
        legend.title = element_text(color = "grey20", 
                                    size = 20)) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5))
```
---
### Exploring the Seasonality of COVID-19
```{r seasons-box-plot, echo = FALSE, fig.width = 16, fig.height = 7.5, fig.alt = "Box plot of cases grouped by season which shows that the winter had the highest median number of cases, folloed by the fall, summer, and spring."}
seasons_deaths_cases %>%
  ggplot(aes(x = total_new_cases / 10^3, 
             y = reorder(season, total_new_cases), 
             fill = season)) +
  geom_boxplot() +
  labs(title = "Ridge Plot Of Total Daily New Cases By Season",
       x = "Daily New Cases (Thousands)",
       y = "Season",
       fill = "Season") +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
        axis.text.x = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),
        axis.text.y = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),  
        axis.title.x = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = 0, 
                                    face = "plain"),
        axis.title.y = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 90, 
                                    hjust = .5, 
                                    vjust = 1, 
                                    face = "plain"),
        plot.title = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = .5, 
                                    face = "plain"),
        legend.text = element_text(color = "grey20", 
                                    size = 15),
        legend.title = element_text(color = "grey20", 
                                    size = 20)) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5))
```
---
### Exploring the Seasonality of COVID-19
Towards the end of this semester, we learned how to create models with 
categorical explanatory variables. Let's run a linear regression by factoring
the `season` variable:
```{r seasons-linear-regression, echo = FALSE}
season_lreg <- linear_reg() %>%
  set_engine("lm") %>%
  fit(total_new_cases ~ factor(season), data = seasons_deaths_cases)

season_lreg

glance(season_lreg)
```
This tells us that the average number of daily new cases in the Fall is 94,747.
It is also possible to derive the daily new cases averages for the other seasons 
from this as well. Additionally, note that $R^2 \approx 0.25$. This tells us that 
about 25% of the of the variation in the daily new cases 
is dependent on the season.
---
### Tying Seasonality into the Relationship Between Cases and Deaths
Finally, let's try to see if the relationship between deaths and cases does or
does not vary by the season. This type of analysis is equivalent to interpreting
main vs. interaction effects. We will start with the main effects:

```{r seasons-main-effects, echo = FALSE}
deaths_cases_main_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(total_new_deaths ~ total_new_cases + factor(season), data = seasons_deaths_cases) 

deaths_cases_int_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(total_new_deaths ~ total_new_cases * factor(season), data = seasons_deaths_cases) 

#deaths_cases_main_fit
#deaths_cases_int_fit

#glance(deaths_cases_main_fit)
#glance(deaths_cases_int_fit)
```

```{r seasons-main-effects-plot, echo = FALSE, message = FALSE, fig.width = 14, fig.height = 6, fig.alt = "Scatterplot of daily new deaths versus daily new cases which shows the main effects for each of the four seasons."}
season_f <- filter(augment(deaths_cases_main_fit$fit), augment(deaths_cases_main_fit$fit)$"factor(season)" %in% c("Fall"))
season_w <- filter(augment(deaths_cases_main_fit$fit), augment(deaths_cases_main_fit$fit)$"factor(season)" %in% c("Winter"))
season_sp <- filter(augment(deaths_cases_main_fit$fit), augment(deaths_cases_main_fit$fit)$"factor(season)" %in% c("Spring"))
season_su <- filter(augment(deaths_cases_main_fit$fit), augment(deaths_cases_main_fit$fit)$"factor(season)" %in% c("Summer"))

ggplot(seasons_deaths_cases) +
  aes(x = total_new_cases, y = total_new_deaths, color = season) +
  geom_point() +
  geom_line(data = season_f, aes(x = total_new_cases, 
                                 y = .fitted), 
            size = 0.75, 
            color = "orange") +
  geom_line(data = season_w, aes(x = total_new_cases, 
                                 y = .fitted), 
            size = 0.75, 
            color = "purple") + 
  geom_line(data = season_sp, aes(x = total_new_cases, 
                                 y = .fitted), 
            size = 0.75, 
            color = "darkolivegreen3") + 
  geom_line(data = season_su, aes(x = total_new_cases, 
                                  y = .fitted), 
            size = 0.75, 
            color = "deepskyblue") +
  labs(title = "Daily New Deaths vs. Daily New Cases",
       x = "Daily New Cases",
       y = "Daily New Deaths",
       color = "Season") +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
        axis.text.x = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),
        axis.text.y = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),  
        axis.title.x = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = 0, 
                                    face = "plain"),
        axis.title.y = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 90, 
                                    hjust = .5, 
                                    vjust = 1, 
                                    face = "plain"),
        plot.title = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = .5, 
                                    face = "plain"),
        legend.text = element_text(color = "grey20", 
                                    size = 17),
        legend.title = element_text(color = "grey20", 
                                    size = 20)) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
```
---
### Tying Seasonality into the Relationship Between Cases and Deaths
Now we will view the interaction effects:

```{r seasons-interaction-effects-plot, echo = FALSE, message = FALSE, fig.width = 14, fig.height = 6, fig.alt = "Scatterplot of daily new deaths versus daily new cases which shows the interaction effects for each of the four seasons."}
season_f <- filter(seasons_deaths_cases, season == "Fall")
season_w <- filter(seasons_deaths_cases, season == "Winter")
season_sp <- filter(seasons_deaths_cases, season == "Spring")
season_su <- filter(seasons_deaths_cases, season == "Summer")


ggplot(seasons_deaths_cases) +
  aes(x = total_new_cases, y = total_new_deaths, color = season) +
  geom_point() +
  geom_smooth(method = "lm", data = season_f, se = FALSE) +
  geom_smooth(method = "lm", data = season_w, se = FALSE) +
  geom_smooth(method = "lm", data = season_sp, se = FALSE) +
  geom_smooth(method = "lm", data = season_su, se = FALSE) +
  labs(title = "Daily New Deaths vs. Daily New Cases",
       x = "Daily New Cases",
       y = "Daily New Deaths",
       color = "Season") +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
        axis.text.x = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),
        axis.text.y = element_text(color = "grey20", 
                                   size = 15, 
                                   angle = 0, 
                                   hjust = .5, 
                                   vjust = .5, 
                                   face = "plain"),  
        axis.title.x = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = 0, 
                                    face = "plain"),
        axis.title.y = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 90, 
                                    hjust = .5, 
                                    vjust = 1, 
                                    face = "plain"),
        plot.title = element_text(color = "grey20", 
                                    size = 30, 
                                    angle = 0, 
                                    hjust = .5, 
                                    vjust = .5, 
                                    face = "plain"),
        legend.text = element_text(color = "grey20", 
                                    size = 15),
        legend.title = element_text(color = "grey20", 
                                    size = 20)) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
```
---
### Tying Seasonality into the Relationship Between Cases and Deaths
```{r deaths-cases-main-fit}
deaths_cases_main_fit
```
Therefore:
$$\hat{deaths} = 63 + 0.011 * cases + 358 * spring + 31 * summer + 548 * winter$$
---
### Tying Seasonality into the Relationship Between Cases and Deaths
```{r deaths-cases-int-fit}
deaths_cases_int_fit
```
Therefore:
$$\hat{d} = 302 + 0.0087 * c + 319 * sp  + 87 * su + 2 * w - 0.0037 * sp * c - 0.0027 * su * c + 0.0053 * w * c$$
---
### Tying Seasonality into the Relationship Between Cases and Deaths
Let's compare the adjusted $R^2$ values:
```{r glance-main-and-int-fits}
glance(deaths_cases_main_fit)
glance(deaths_cases_int_fit)
```
It appears that adding the `season` variable increased adjusted $R^2$, so it makes
sense to include it in our model.
---
### Conclusions and Takeaways
- There is a positive linear relationship between cases and deaths
- Deaths are most correlated to cases with a 7 day lag
- Vaccination percentages vary widely by age group
- There is an approximately 65 day lag until daily new deaths and percent
of population fully vaccinated becomes negatively correlated. 
- There is a relationship between the season and COVID-19 cases/deaths numbers
- Knowing the season improves our ability to model deaths versus cases
---
<style>
.center2 {
  margin: 0;
  position: absolute;
  top: 50%;
  left: 50%;
  -ms-transform: translate(-50%, -50%);
  transform: translate(-50%, -50%);
}
</style>
.center2[
# Questions?
]

